# lucene-kmp/.github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '**.sh'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '**.sh'

jobs:
  tests:
    name: Test (${{ matrix.platform }}/${{ matrix.module_name }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # JVM
          - platform: jvm
            module_name: core
            os: ubuntu-latest
            timeout: 10
            task: :core:jvmTest
            artifact: jvm-core-reports
          - platform: jvm
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 10
            task: :analysis:common:jvmTest
            artifact: jvm-analysis-common-reports
          - platform: jvm
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 10
            task: :analysis:morfologik:jvmTest
            artifact: jvm-analysis-morfologik-reports
          - platform: jvm
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 10
            task: :analysis:smartcn:jvmTest
            artifact: jvm-analysis-smartcn-reports
          - platform: jvm
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 10
            task: :analysis:nori:jvmTest
            artifact: jvm-analysis-nori-reports

          # Android
          - platform: android
            module_name: core
            os: ubuntu-latest
            timeout: 10
            task: :core:testReleaseUnitTest
            artifact: android-core-reports
            needs_android: true
          - platform: android
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 10
            task: :analysis:common:testReleaseUnitTest
            artifact: android-analysis-common-reports
            needs_android: true
          - platform: android
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 10
            task: :analysis:morfologik:testReleaseUnitTest
            artifact: android-analysis-morfologik-reports
            needs_android: true
          - platform: android
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 10
            task: :analysis:smartcn:testReleaseUnitTest
            artifact: android-analysis-smartcn-reports
            needs_android: true
          - platform: android
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 10
            task: :analysis:nori:testReleaseUnitTest
            artifact: android-analysis-nori-reports
            needs_android: true

          # iOS
          - platform: ios
            module_name: core
            os: macos-latest
            timeout: 25
            task: :core:iosSimulatorArm64Test
            artifact: ios-core-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-common
            os: macos-latest
            timeout: 20
            task: :analysis:common:iosSimulatorArm64Test
            artifact: ios-analysis-common-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-morfologik
            os: macos-latest
            timeout: 20
            task: :analysis:morfologik:iosSimulatorArm64Test
            artifact: ios-analysis-morfologik-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-smartcn
            os: macos-latest
            timeout: 20
            task: :analysis:smartcn:iosSimulatorArm64Test
            artifact: ios-analysis-smartcn-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-nori
            os: macos-latest
            timeout: 20
            task: :analysis:nori:iosSimulatorArm64Test
            artifact: ios-analysis-nori-reports
            needs_konan_cache: true

          # Linux
          - platform: linux
            module_name: core
            os: ubuntu-latest
            timeout: 20
            task: :core:linuxX64Test
            artifact: linux-core-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 20
            task: :analysis:common:linuxX64Test
            artifact: linux-analysis-common-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 20
            task: :analysis:morfologik:linuxX64Test
            artifact: linux-analysis-morfologik-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 20
            task: :analysis:smartcn:linuxX64Test
            artifact: linux-analysis-smartcn-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 20
            task: :analysis:nori:linuxX64Test
            artifact: linux-analysis-nori-reports
            needs_konan_cache: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        if: ${{ matrix.platform == 'jvm' }}
        uses: gradle/wrapper-validation-action@v3

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Set up Android SDK
        if: ${{ matrix.needs_android }}
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Konan cache
        if: ${{ matrix.needs_konan_cache }}
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', '**/gradle.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Run tests
        run: ./gradlew -PenableHangDetection=true ${{ matrix.task }}

      - name: Upload build reports
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            **/build/reports/
            **/build/test-results/

      - name: Build Summary
        if: always()
        run: |
          echo "### ${{ matrix.platform }} \- ${{ matrix.module_name }} Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "* Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "* Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "* Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "* Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  coverage:
    name: Coverage
    needs: [tests]
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Konan cache
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', '**/gradle.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Coverage :core
        run: ./gradlew :core:koverXmlReport

      - name: Coverage :analysis:common
        run: ./gradlew :analysis:common:koverXmlReport

      - name: Coverage :analysis:morfologik
        run: ./gradlew :analysis:morfologik:koverXmlReport 
          -x :analysis:morfologik:compileDebugKotlinAndroid \
          -x :analysis:morfologik:compileReleaseKotlinAndroid \
          -x :analysis:morfologik:compileDebugUnitTestKotlinAndroid \
          -x :analysis:morfologik:compileReleaseUnitTestKotlinAndroid \
          -x :analysis:morfologik:koverGenerateArtifactDebug \
          -x :analysis:morfologik:koverGenerateArtifactRelease

      - name: Coverage :analysis:smartcn
        run: ./gradlew :analysis:smartcn:koverXmlReport \
          -x :analysis:smartcn:compileDebugKotlinAndroid \
          -x :analysis:smartcn:compileReleaseKotlinAndroid \
          -x :analysis:smartcn:compileDebugUnitTestKotlinAndroid \
          -x :analysis:smartcn:compileReleaseUnitTestKotlinAndroid \
          -x :analysis:smartcn:koverGenerateArtifactDebug \
          -x :analysis:smartcn:koverGenerateArtifactRelease

      - name: Coverage :analysis:nori
        run: ./gradlew :analysis:nori:koverXmlReport \
          -x :analysis:nori:compileDebugKotlinAndroid \
          -x :analysis:nori:compileReleaseKotlinAndroid \
          -x :analysis:nori:compileDebugUnitTestKotlinAndroid \
          -x :analysis:nori:compileReleaseUnitTestKotlinAndroid \
          -x :analysis:nori:koverGenerateArtifactDebug \
          -x :analysis:nori:koverGenerateArtifactRelease

      - name: Upload coverage reports to Codecov
        if: ${{ env.ACT != 'true' }}
        uses: codecov/codecov-action@v5
        with:
          files: |
            core/build/reports/kover/report.xml
            analysis/common/build/reports/kover/report.xml
            analysis/morfologik/build/reports/kover/report.xml
            analysis/smartcn/build/reports/kover/report.xml
            analysis/nori/build/reports/kover/report.xml
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload build reports
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            core/build/reports/kover/
            analysis/common/build/reports/kover/
            analysis/morfologik/build/reports/kover/
            analysis/smartcn/build/reports/kover/
            analysis/nori/build/reports/kover/
            build/reports/
