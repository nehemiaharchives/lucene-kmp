# lucene-kmp/.github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '**.sh'
      - '**.main.kts'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '**.sh'
      - '**.main.kts'

jobs:
  tests:
    name: Test (${{ matrix.platform }}/${{ matrix.module_name }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # JVM
          - platform: jvm
            module_name: core-analysis
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.analysis*"
            artifact: jvm-core-analysis-reports
          - platform: jvm
            module_name: core-codecs
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.codecs*"
            artifact: jvm-core-codecs-reports
          - platform: jvm
            module_name: core-document
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.document*"
            artifact: jvm-core-document-reports
          - platform: jvm
            module_name: core-geo
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.geo*"
            artifact: jvm-core-geo-reports
          - platform: jvm
            module_name: core-index
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.index*"
            artifact: jvm-core-index-reports
          - platform: jvm
            module_name: core-internal
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.internal*"
            artifact: jvm-core-internal-reports
          - platform: jvm
            module_name: core-jdkport
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.jdkport*"
            artifact: jvm-core-jdkport-reports
          - platform: jvm
            module_name: core-search
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.search*"
            artifact: jvm-core-search-reports
          - platform: jvm
            module_name: core-store
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.store*"
            artifact: jvm-core-store-reports
          - platform: jvm
            module_name: core-util
            os: ubuntu-latest
            timeout: 40
            task: :core:jvmTest
            package_filter: --tests "org.gnit.lucenekmp.util*"
            artifact: jvm-core-util-reports
          - platform: jvm
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 40
            task: :analysis:common:jvmTest
            artifact: jvm-analysis-common-reports
          - platform: jvm
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 40
            task: :analysis:morfologik:jvmTest
            artifact: jvm-analysis-morfologik-reports
          - platform: jvm
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 40
            task: :analysis:smartcn:jvmTest
            artifact: jvm-analysis-smartcn-reports
          - platform: jvm
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 40
            task: :analysis:nori:jvmTest
            artifact: jvm-analysis-nori-reports
          - platform: jvm
            module_name: analysis-kuromoji
            os: ubuntu-latest
            timeout: 40
            task: :analysis:kuromoji:jvmTest
            artifact: jvm-analysis-kuromoji-reports
          - platform: jvm
            module_name: analysis-extra
            os: ubuntu-latest
            timeout: 40
            task: :analysis:extra:jvmTest
            artifact: jvm-analysis-extra-reports
          - platform: jvm
            module_name: codecs
            os: ubuntu-latest
            timeout: 60
            task: :codecs:jvmTest
            artifact: jvm-codecs-reports

          # Android
          - platform: android
            module_name: core-analysis
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.analysis*"
            artifact: android-core-analysis-reports
            needs_android: true
          - platform: android
            module_name: core-codecs
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.codecs*"
            artifact: android-core-codecs-reports
            needs_android: true
          - platform: android
            module_name: core-document
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.document*"
            artifact: android-core-document-reports
            needs_android: true
          - platform: android
            module_name: core-geo
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.geo*"
            artifact: android-core-geo-reports
            needs_android: true
          - platform: android
            module_name: core-index
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.index*"
            artifact: android-core-index-reports
            needs_android: true
          - platform: android
            module_name: core-internal
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.internal*"
            artifact: android-core-internal-reports
            needs_android: true
          - platform: android
            module_name: core-jdkport
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.jdkport*"
            artifact: android-core-jdkport-reports
            needs_android: true
          - platform: android
            module_name: core-search
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.search*"
            artifact: android-core-search-reports
            needs_android: true
          - platform: android
            module_name: core-store
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.store*"
            artifact: android-core-store-reports
            needs_android: true
          - platform: android
            module_name: core-util
            os: ubuntu-latest
            timeout: 40
            task: :core:testAndroidHostTest
            package_filter: --tests "org.gnit.lucenekmp.util*"
            artifact: android-core-util-reports
            needs_android: true
          - platform: android
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 40
            task: :analysis:common:testAndroidHostTest
            artifact: android-analysis-common-reports
            needs_android: true
          - platform: android
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 40
            task: :analysis:morfologik:testAndroidHostTest
            artifact: android-analysis-morfologik-reports
            needs_android: true
          - platform: android
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 40
            task: :analysis:smartcn:testAndroidHostTest
            artifact: android-analysis-smartcn-reports
            needs_android: true
          - platform: android
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 40
            task: :analysis:nori:testAndroidHostTest
            artifact: android-analysis-nori-reports
            needs_android: true
          - platform: android
            module_name: analysis-kuromoji
            os: ubuntu-latest
            timeout: 40
            task: :analysis:kuromoji:testAndroidHostTest
            artifact: android-analysis-kuromoji-reports
            needs_android: true
          - platform: android
            module_name: analysis-extra
            os: ubuntu-latest
            timeout: 40
            task: :analysis:extra:testAndroidHostTest
            artifact: android-analysis-extra-reports
            needs_android: true
          - platform: android
            module_name: codecs
            os: ubuntu-latest
            timeout: 50
            task: :codecs:testAndroidHostTest
            artifact: android-codecs-reports
            needs_android: true

          # iOS
          - platform: ios
            module_name: core-analysis
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.analysis*"
            artifact: ios-core-analysis-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-codecs
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.codecs*"
            artifact: ios-core-codecs-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-document
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.document*"
            artifact: ios-core-document-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-geo
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.geo*"
            artifact: ios-core-geo-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-index
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.index*"
            artifact: ios-core-index-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-internal
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.internal*"
            artifact: ios-core-internal-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-jdkport
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.jdkport*"
            artifact: ios-core-jdkport-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-search
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.search*"
            artifact: ios-core-search-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-store
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.store*"
            artifact: ios-core-store-reports
            needs_konan_cache: true
          - platform: ios
            module_name: core-util
            os: macos-latest
            timeout: 40
            task: :core:iosSimulatorArm64Test
            package_filter: --tests "org.gnit.lucenekmp.util*"
            artifact: ios-core-util-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-common
            os: macos-latest
            timeout: 40
            task: :analysis:common:iosSimulatorArm64Test
            artifact: ios-analysis-common-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-morfologik
            os: macos-latest
            timeout: 40
            task: :analysis:morfologik:iosSimulatorArm64Test
            artifact: ios-analysis-morfologik-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-smartcn
            os: macos-latest
            timeout: 40
            task: :analysis:smartcn:iosSimulatorArm64Test
            artifact: ios-analysis-smartcn-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-nori
            os: macos-latest
            timeout: 40
            task: :analysis:nori:iosSimulatorArm64Test
            artifact: ios-analysis-nori-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-kuromoji
            os: macos-latest
            timeout: 40
            task: :analysis:kuromoji:iosSimulatorArm64Test
            artifact: ios-analysis-kuromoji-reports
            needs_konan_cache: true
          - platform: ios
            module_name: analysis-extra
            os: macos-latest
            timeout: 40
            task: :analysis:extra:iosSimulatorArm64Test
            artifact: ios-analysis-extra-reports
            needs_konan_cache: true
          - platform: ios
            module_name: codecs
            os: macos-latest
            timeout: 50
            task: :codecs:iosSimulatorArm64Test
            artifact: ios-codecs-reports
            needs_konan_cache: true

          # Linux
          - platform: linux
            module_name: core-analysis
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.analysis*"
            artifact: linux-core-analysis-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-codecs
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.codecs*"
            artifact: linux-core-codecs-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-document
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.document*"
            artifact: linux-core-document-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-geo
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.geo*"
            artifact: linux-core-geo-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-index
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.index*"
            artifact: linux-core-index-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-internal
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.internal*"
            artifact: linux-core-internal-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-jdkport
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.jdkport*"
            artifact: linux-core-jdkport-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-search
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.search*"
            artifact: linux-core-search-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-store
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.store*"
            artifact: linux-core-store-reports
            needs_konan_cache: true
          - platform: linux
            module_name: core-util
            os: ubuntu-latest
            timeout: 50
            task: :core:linuxX64Test
            package_filter: --tests "org.gnit.lucenekmp.util*"
            artifact: linux-core-util-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-common
            os: ubuntu-latest
            timeout: 40
            task: :analysis:common:linuxX64Test
            artifact: linux-analysis-common-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-morfologik
            os: ubuntu-latest
            timeout: 40
            task: :analysis:morfologik:linuxX64Test
            artifact: linux-analysis-morfologik-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-smartcn
            os: ubuntu-latest
            timeout: 40
            task: :analysis:smartcn:linuxX64Test
            artifact: linux-analysis-smartcn-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-nori
            os: ubuntu-latest
            timeout: 40
            task: :analysis:nori:linuxX64Test
            artifact: linux-analysis-nori-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-kuromoji
            os: ubuntu-latest
            timeout: 40
            task: :analysis:kuromoji:linuxX64Test
            artifact: linux-analysis-kuromoji-reports
            needs_konan_cache: true
          - platform: linux
            module_name: analysis-extra
            os: ubuntu-latest
            timeout: 40
            task: :analysis:extra:linuxX64Test
            artifact: linux-analysis-extra-reports
            needs_konan_cache: true
          - platform: linux
            module_name: codecs
            os: ubuntu-latest
            timeout: 50
            task: :codecs:linuxX64Test
            artifact: linux-codecs-reports
            needs_konan_cache: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        if: ${{ matrix.platform == 'jvm' }}
        uses: gradle/wrapper-validation-action@v3

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Set up Android SDK
        if: ${{ matrix.needs_android }}
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Konan cache
        if: ${{ matrix.needs_konan_cache }}
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', '**/gradle.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Run tests
        run: >
          ./gradlew
          -PenableHangDetection=true
          --stacktrace
          --console=plain
          ${{ matrix.task }}
          ${{ matrix.package_filter || '' }}

      - name: Upload build reports
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            **/build/reports/
            **/build/test-results/

      - name: Build Summary
        if: always()
        run: |
          echo "### ${{ matrix.platform }} \- ${{ matrix.module_name }} Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "* Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "* Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "* Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "* Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  coverage:
    name: Coverage
    needs: [tests]
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Konan cache
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', '**/gradle.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Coverage :core
        run: ./gradlew :core:koverXmlReport

      - name: Coverage :analysis:common
        run: ./gradlew :analysis:common:koverXmlReport

      - name: Coverage :analysis:morfologik
        run: >
          ./gradlew :analysis:morfologik:koverXmlReport
          -x :analysis:morfologik:compileAndroidDeviceTest 
          -x :analysis:morfologik:compileAndroidHostTest
          -x :analysis:morfologik:compileAndroidMain
          -x :analysis:morfologik:koverGenerateArtifactAndroid

      - name: Coverage :analysis:smartcn
        run: >
          ./gradlew :analysis:smartcn:koverXmlReport
          -x :analysis:smartcn:compileAndroidDeviceTest
          -x :analysis:smartcn:compileAndroidHostTest
          -x :analysis:smartcn:compileAndroidMain
          -x :analysis:smartcn:koverGenerateArtifactAndroid

      - name: Coverage :analysis:nori
        run: >
          ./gradlew :analysis:nori:koverXmlReport
          -x :analysis:nori:compileAndroidDeviceTest
          -x :analysis:nori:compileAndroidHostTest
          -x :analysis:nori:compileAndroidMain
          -x :analysis:nori:koverGenerateArtifactAndroid
      
      - name: Coverage :analysis:kuromoji
        run: >
          ./gradlew :analysis:kuromoji:koverXmlReport
          -x :analysis:kuromoji:compileAndroidDeviceTest
          -x :analysis:kuromoji:compileAndroidHostTest
          -x :analysis:kuromoji:compileAndroidMain
          -x :analysis:kuromoji:koverGenerateArtifactAndroid
      
      - name: Coverage :analysis:extra
        run: >
          ./gradlew :analysis:extra:koverXmlReport
          -x :analysis:extra:compileAndroidDeviceTest
          -x :analysis:extra:compileAndroidHostTest
          -x :analysis:extra:compileAndroidMain
          -x :analysis:extra:koverGenerateArtifactAndroid
      - name: Coverage :codecs
        run: >
          ./gradlew :codecs:koverXmlReport
          -x :codecs:compileAndroidDeviceTest
          -x :codecs:compileAndroidHostTest
          -x :codecs:compileAndroidMain
          -x :codecs:koverGenerateArtifactAndroid

      - name: Upload coverage reports to Codecov
        if: ${{ env.ACT != 'true' }}
        uses: codecov/codecov-action@v5
        with:
          files: |
            core/build/reports/kover/report.xml
            analysis/common/build/reports/kover/report.xml
            analysis/morfologik/build/reports/kover/report.xml
            analysis/smartcn/build/reports/kover/report.xml
            analysis/nori/build/reports/kover/report.xml
            analysis/kuromoji/build/reports/kover/report.xml
            analysis/extra/build/reports/kover/report.xml
            codecs/build/reports/kover/report.xml
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload build reports
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            core/build/reports/kover/
            analysis/common/build/reports/kover/
            analysis/morfologik/build/reports/kover/
            analysis/smartcn/build/reports/kover/
            analysis/nori/build/reports/kover/
            analysis/kuromoji/build/reports/kover/
            analysis/extra/build/reports/kover/
            codecs/build/reports/kover/
            build/reports/
